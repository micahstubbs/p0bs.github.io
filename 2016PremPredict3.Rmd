---
title: "They think it's all over ..."
output:
  html_document:
    theme: sandstone
    highlight: pygments
    include:
      after_body: footer.html
---

... and it pretty much is. Well done, Roger -- you've topped the table for some time and you're almost sure to do so after the final day.

Whilst the numbers don't round perfectly, my calculations show that three of us still have some chance of winning. (Of course, others may also have a tiny chance of winning but my calculations don't show it.) 

Pausing to create dramatic tension, I can reveal that:

  * Roger Gathercole has a 97% shot at glory;
  
  * I have a 3% chance of winning; and
  
  * Beth has a 1% chance of winning.
 
The only downside with the nature of the scores this year, though, is that it's tough to ascribe someone's eventual victory to one particular score on Sunday, as there are so many different permutations.

Here are the standings:

```{r thecode, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, error=TRUE}

setwd("~/GitHub/p0bs.github.io/")

library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(htmlwidgets)
library(DT)
library(magrittr)

# Start by running this dimmed code (as PP-thin.R):
# library(rvest)
# library(xml2)
# leagueTable <- read_html("http://www.theguardian.com/football/premierleague/table")
# clubOrder <- leagueTable %>%
#   html_nodes(".table--striped") %>%
#   .[[1]] %>%
#   html_table()
# saveRDS(clubOrder, "clubOrder.rds")  # Add date
# Then move clubOrder.rds to appropriate GitHub drive

clubOrder <- readRDS("clubOrder160514.rds")  # Add date

# Rename some teams to make the league table consistent with our inputs
clubOrder$Team[clubOrder$Team=="Leicester"] <- "Leicester City"
clubOrder$Team[clubOrder$Team=="Spurs"] <- "Tottenham Hotspur"
clubOrder$Team[clubOrder$Team=="AFC Bournemouth"] <- "Bournemouth"
clubOrder$Team[clubOrder$Team=="C Palace"] <- "Crystal Palace"
clubOrder$Team[clubOrder$Team=="Man City"] <- "Manchester City"
clubOrder$Team[clubOrder$Team=="Man Utd"] <- "Manchester United"
clubOrder$Team[clubOrder$Team=="West Ham"] <- "West Ham United"
clubOrder$Team[clubOrder$Team=="Stoke"] <- "Stoke City"
clubOrder$Team[clubOrder$Team=="Swansea"] <- "Swansea City"
clubOrder$Team[clubOrder$Team=="West Brom"] <- "West Bromwich Albion"
clubOrder$Team[clubOrder$Team=="Norwich"] <- "Norwich City"
clubOrder$Team[clubOrder$Team=="Newcastle"] <- "Newcastle United"

clubsABC <- sort(clubOrder$Team)

dataInput <- read_csv("PP-2015.csv")
clubStandings <- match(dataInput$Club, clubOrder$Team, 0)
topClub <- match(1, clubStandings, 0)

predictions <- dataInput[,-1]

bonus <- -50*(predictions[topClub,]==1)
ssq <- function(x){(x-clubStandings)^2}
squares <- apply(predictions,2,ssq)
score <- colSums(squares) + bonus
names <- colnames(score)
names1 <- str_replace_all(names, "_", " ")
worst <- apply(squares,2,max)
findWorst <- function(y){match(worst[y],squares[,y],0)}
worstClubNo <- sapply(1:ncol(predictions),findWorst)
worstClub <- clubsABC[worstClubNo]

output <- rbind(score, bonus, worst, worstClubNo)
output1 <- data.frame(names1,t(output))
row.names(output1) <- NULL 
output2 <- output1 %>% 
  mutate(worstClub=clubsABC[worstClubNo]) %>%
  select(-worstClubNo) 
colnames(output2) <- c("Names", "Scores", "Bonus", "WorstCost", "WorstClub")

report <- output2 %>% 
  arrange(Scores) %>% 
  select(Names, Scores, Bonus, WorstClub, WorstCost)
datatable(report, 
          rownames = FALSE, 
          options = list(dom = 't',
                         pageLength = 23,
                         order = list(list(1, 'asc'), list(0, 'asc'))))
```

<br></br>

Remember: if you want up-to-the-hour standings, just check [here](https://robin.shinyapps.io/PremPredict).

I'll be in touch again shortly after the final round of games. But, bottom line: you can feel pretty safe, Roger. Then again, Leicester were longer odds than me and Beth to win and look what happened there!

-- Robin

---

PS Here's my code to prove that all is kosher:

```{r thecode, eval=FALSE, echo=TRUE}
```

And, for completeness, here are your team-by-team predictions and each team's latest position in the league:

```{r thepredictions, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}

Position <- as.vector(1:20)
clubsOrder <- clubOrder$Team
clubsOrder1 <- as.data.frame(cbind(clubsOrder, Position)) %>% 
  rename(Club = clubsOrder) %>% 
  left_join(dataInput, by = "Club")

datatable(clubsOrder1,
          rownames = FALSE,
          options = list(dom = 't',
                         pageLength = 20,
                         order = list(0, 'asc'),
                         columnDefs = list(list(
            className = 'dt-right', targets = 1))))
```

---
